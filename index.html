<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title></title>
    <script src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
    <script src="http://code.highcharts.com/highcharts.js"></script>
    <script src="http://code.highcharts.com/modules/exporting.js"></script>
    <script src="script/socket.io-1.3.5.js"></script>
    <link rel="stylesheet" type="text/css" href="bar.css">
</head>

<body>

<select id="timeIntervall" style="width: 100px">
    <option value="1">Minute</option>
    <!--<option value="2">5 minutes</option>-->
    <option value="3" selected="selected">Hour</option>
    <option value="4">Today</option>
    <option value="5">Yesterday</option>
    <option value="6">Week</option>
    <option value="7">Month</option>
    <!--<option value="8">Year</option>-->
</select>

<div id="containerSession" style="min-width: 310px; height: 400px; margin: 0 auto"></div>
<div id="containerPla" style="min-width: 310px; height: 400px; margin: 0 auto"></div>

<div style='width:100%'>

    <div class="barchar2">
        <div id="containerProduct" style="margin: 0 auto"></div>
    </div>
    <div class="barchar2">
        <div id="containerProfile" style="margin: 0 auto"></div>
    </div>

</div>

<div style='width:100%'>

    <div class="barchar3">
        <div id="containerISP" style="margin: 0 auto"></div>
    </div>
    <div class="barchar3">
        <div id="containerDevice" style="margin: 0 auto"></div>
    </div>
    <div class="barchar3">
        <div id="containerInfo" style="margin: 0 auto"></div>
    </div>

</div>

<script>
    var socket = io.connect("http://23.99.96.65:8082")
    //    var socket = io.connect("http://localhost:3000");

    socket.emit("messageHH", "HH");
    socket.emit("productHH", "HH");
    socket.emit("profileHH", "HH");
    socket.emit("ispHH", "HH");
    socket.emit("deviceHH", "HH");
    socket.emit("infoHH", "HH");

    $(function () {
        $('#timeIntervall').change(function (event) {
            console.log($(this).val());
//
//            switch ($(this).val()) {
//                case 1:
//                    socket.emit("messagemm", "mm");
//                    socket.emit("productmm", "mm");
//                    socket.emit("profilemm", "mm");
//                    socket.emit("ispmm", "mm");
//                    socket.emit("devicemm", "mm");
//                    socket.emit("infomm", "mm");
//                    break;
//                case 2:
//                    socket.emit("message5m", "mm");
//                    socket.emit("product5m", "mm");
//                    socket.emit("profile5m", "mm");
//                    socket.emit("isp5m", "mm");
//                    socket.emit("device5m", "mm");
//                    socket.emit("info5m", "mm");
//                    break;
//                case 3:
//                    socket.emit("messageHH", "HH");
////                socket.emit("productHH", "HH");
////                socket.emit("profileHH", "HH");
////                socket.emit("ispHH", "HH");
////                socket.emit("deviceHH", "HH");
////                socket.emit("infoHH", "HH");
//                    break;
//                case 4:
//                    socket.emit("messageHToday", "HH");
////                socket.emit("productHH", "HH");
////                socket.emit("profileHH", "HH");
////                socket.emit("ispHH", "HH");
////                socket.emit("deviceHH", "HH");
////                socket.emit("infoHH", "HH");
//                    break;
//                case 5:
//                    socket.emit("messageHYesterday", "HH");
////                socket.emit("productHH", "HH");
////                socket.emit("profileHH", "HH");
////                socket.emit("ispHH", "HH");
////                socket.emit("deviceHH", "HH");
////                socket.emit("infoHH", "HH");
//                    break;
//                case 6:
//                    socket.emit("messaged7", "d7");
//                    socket.emit("productd7", "d7");
//                    socket.emit("profiled7", "d7");
//                    socket.emit("ispd7", "d7");
//                    socket.emit("deviced7", "d7");
//                    socket.emit("infod7", "d7");
//                    break;
//                case 7:
//                    socket.emit("messaged30", "d30");
//                    socket.emit("productd30", "d30");
//                    socket.emit("profiled30", "d30");
//                    socket.emit("ispd30", "d30");
//                    socket.emit("deviced30", "d30");
//                    socket.emit("infod30", "d30");
//                    break;
//                case 8:
//                    socket.emit("messaged30", "d30");
//                    socket.emit("productd30", "d30");
//                    socket.emit("profiled30", "d30");
//                    socket.emit("ispd30", "d30");
//                    socket.emit("deviced30", "d30");
//                    socket.emit("infod30", "d30");
//                    break;
//            }

            if ($(this).val() == 1) {//minutes
                socket.emit("messagemm", "mm");
                socket.emit("productmm", "mm");
                socket.emit("profilemm", "mm");
                socket.emit("ispmm", "mm");
                socket.emit("devicemm", "mm");
                socket.emit("infomm", "mm");
            } else if ($(this).val() == 2) {//5 minutes
                socket.emit("message5m", "mm");
                socket.emit("product5m", "mm");
                socket.emit("profile5m", "mm");
                socket.emit("isp5m", "mm");
                socket.emit("device5m", "mm");
                socket.emit("info5m", "mm");
            } else if ($(this).val() == 3) {//hours
                socket.emit("messageHH", "HH");
                socket.emit("productHH", "HH");
                socket.emit("profileHH", "HH");
                socket.emit("ispHH", "HH");
                socket.emit("deviceHH", "HH");
                socket.emit("infoHH", "HH");
            } else if ($(this).val() == 4) {//today
                socket.emit("messageHToday", "HH");
                socket.emit("productdd", "dd");
                socket.emit("profiledd", "dd");
                socket.emit("ispdd", "dd");
                socket.emit("devicedd", "dd");
                socket.emit("infodd", "dd");
            } else if ($(this).val() == 5) {//yesterday
                socket.emit("messageHYesterday", "HH");
                socket.emit("productdd", "dd");
                socket.emit("profiledd", "dd");
                socket.emit("ispdd", "dd");
                socket.emit("devicedd", "dd");
                socket.emit("infodd", "dd");
            } else if ($(this).val() == 6) {//week
                socket.emit("messaged7", "d7");
                socket.emit("productd7", "d7");
                socket.emit("profiled7", "d7");
                socket.emit("ispd7", "d7");
                socket.emit("deviced7", "d7");
                socket.emit("infod7", "d7");
            } else if ($(this).val() == 7) {//month
                socket.emit("messaged30", "d30");
                socket.emit("productd30", "d30");
                socket.emit("profiled30", "d30");
                socket.emit("ispd30", "d30");
                socket.emit("deviced30", "d30");
                socket.emit("infod30", "d30");
            }

        });
    })

    function drawData(data, setContainer) {
        var dataX = []
        var dataSubY = []
        var keys = Object.keys(data);
        for (var i = keys.length - 1; i >= 0; i--) {
            var dateString = data[keys[i]].date_min
            var year = dateString.substring(0, 4);
            var month = dateString.substring(4, 6);
            var day = dateString.substring(6, 8);
            var hour = dateString.substring(8, 10);
            var minute = dateString.substring(10, 12);
            var date = new Date(year, month - 1, day, hour, minute)
            date.setHours(date.getHours() + 7)
            dataX.push(date.toLocaleDateString() + " " + date.getHours() + ":" + date.getMinutes())
            console.log(date.toLocaleDateString() + " " + date.getHours() + ":" + date.getMinutes())
            dataSubY.push(data[keys[i]].value);

        }
        var dataY = [{
            name: 'All',
            data: dataSubY
        }]

        $(setContainer).highcharts({

            title: {
                text: 'Average Session',
                x: -20 //center
            },
            subtitle: {
                text: 'Source: Nginx and Wowza Stream',
                x: -20
            },

            xAxis: {
                categories: dataX
            },
            yAxis: {
                title: {
                    text: 'Unique count of session'
                },
                plotLines: [{
                    value: 0,
                    width: 1,
                    color: '#808080'
                }]
            },
            tooltip: {
                valueSuffix: ' session'
            },
            legend: {
                layout: 'vertical',
                align: 'right',
                verticalAlign: 'middle',
                borderWidth: 0
            },
            series: dataY
        });
    }

    function drawDataArray(data, paraTitle, setContainer, paraI) {
        if (paraI === 1) {
            var keys = Object.keys(data)
            var array = data[keys[0]].value
        } else if (paraI === 2) {
            var array = data
            console.log("D7")
        }
        console.log(array)
        $(setContainer).highcharts({
            chart: {
                plotBackgroundColor: null,
                plotBorderWidth: null,
                plotShadow: false,
                type: 'pie'
            },
            title: {
                text: paraTitle
            },
            tooltip: {
                pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b>'
            },
            plotOptions: {
                pie: {
                    allowPointSelect: true,
                    cursor: 'pointer',
                    dataLabels: {
                        enabled: true,
                        format: '<b>{point.name}</b>: {point.percentage:.1f} %',
                        style: {
                            color: (Highcharts.theme && Highcharts.theme.contrastTextColor) || 'black'
                        }
                    }
                }
            },
            series: [{
                name: "Brands",
                colorByPoint: true,
                data: array
            }]
        });
    }

    function drawDataAgg(data, paraTitle, setContainer) {

        var keys = Object.keys(data)
        var array = data[keys[0]].value

        console.log(array)
        $(setContainer).highcharts({
            chart: {
                plotBackgroundColor: null,
                plotBorderWidth: null,
                plotShadow: false,
                type: 'pie'
            },
            title: {
                text: paraTitle
            },
            tooltip: {
                pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b>'
            },
            plotOptions: {
                pie: {
                    allowPointSelect: true,
                    cursor: 'pointer',
                    dataLabels: {
                        enabled: true,
                        format: '<b>{point.name}</b>: {point.percentage:.1f} %',
                        style: {
                            color: (Highcharts.theme && Highcharts.theme.contrastTextColor) || 'black'
                        }
                    }
                }
            },
            series: [{
                name: "Brands",
                colorByPoint: true,
                data: array
            }]
        });
    }

    function socketData(paraChannel, setContainer) {

        socket.on(paraChannel, function (data) {

            console.log(data)
            drawData(data, setContainer)

        })

    }

    function socketDataArray(paraChannel, paraTitle, setContainer) {

        socket.on(paraChannel, function (data) {

            console.log(data)
            if (paraChannel === "product_time"
                    || paraChannel === "profile_time"
                    || paraChannel === "isp_time"
                    || paraChannel === "device_time"
                    || paraChannel === "info_time") {
                drawDataArray(data, paraTitle, setContainer, 1)
            } else if (paraChannel === "product_time7"
                    || paraChannel === "profile_time7"
                    || paraChannel === "isp_time7"
                    || paraChannel === "device_time7"
                    || paraChannel === "info_time7") {
                drawDataArray(data, paraTitle, setContainer, 2)
            }

        })

    }

    $(function () {

        socketData("sessions_time", '#containerSession')
        socketDataArray("product_time", 'Product\'s HDViet', '#containerProduct')
        socketDataArray("product_time7", 'Product\'s HDViet', '#containerProduct')
        socketDataArray("profile_time", 'Profile\'s HDViet', '#containerProfile')
        socketDataArray("profile_time7", 'Profile\'s HDViet', '#containerProfile')
        socketDataArray("isp_time", 'ISP\'s HDViet', '#containerISP')
        socketDataArray("isp_time7", 'ISP\'s HDViet', '#containerISP')
        socketDataArray("device_time", 'Device\'s HDViet', '#containerDevice')
        socketDataArray("device_time7", 'Device\'s HDViet', '#containerDevice')
        socketDataArray("info_time", 'Info\'s HDViet', '#containerInfo')
        socketDataArray("info_time7", 'Info\'s HDViet', '#containerInfo')

    });

</script>

</body>
</html>