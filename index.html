<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title></title>
    <script src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
    <script src="http://code.highcharts.com/highcharts.js"></script>
    <script src="http://code.highcharts.com/modules/exporting.js"></script>
    <script src="script/socket.io-1.3.5.js"></script>
    <link rel="stylesheet" type="text/css" href="bar.css">


</head>
<body>
<select id="timeIntervall" style="width: 100px">
    <option value="1">1 minute</option>
    <option value="2">5 minutes</option>
    <option value="3">1 hour</option>
    <option value="4">1 day</option>
    <option value="5">1 month</option>
</select>

<div id="containerSession" style="min-width: 310px; height: 400px; margin: 0 auto"></div>


<div style='width:100%'>
    <div class="barchar2">
        <div id="containerProduct" style="margin: 0 auto"></div>
    </div>
    <div class="barchar2">
        <div id="containerProfile" style="margin: 0 auto"></div>
    </div>

</div>

<div style='width:100%'>

    <div class="barchar3">
        <div id="containerISP" style="margin: 0 auto"></div>
    </div>
    <div class="barchar3">
        <div id="containerDevice" style="margin: 0 auto"></div>
    </div>
    <div class="barchar3">
        <div id="containerInfo" style="margin: 0 auto"></div>
    </div>

</div>

<script>
        var socket = io.connect("http://23.99.96.65:8082")
//    var socket = io.connect("http://localhost:3000");

    socket.emit("messagemm", "mm");
    socket.emit("productmm", "mm");
    socket.emit("profilemm", "mm");
    socket.emit("ispmm", "mm");
    socket.emit("devicemm", "mm");
    socket.emit("infomm", "mm");

    $(function () {
        $('#timeIntervall').change(function (event) {
            console.log($(this).val());

            if ($(this).val() == 1) {
                socket.emit("messagemm", "mm");
                socket.emit("productmm", "mm");
                socket.emit("profilemm", "mm");
                socket.emit("ispmm", "mm");
                socket.emit("devicemm", "mm");
                socket.emit("infomm", "mm");
            } else if ($(this).val() == 2) {
                socket.emit("message5m", "mm");
                socket.emit("product5m", "mm");
                socket.emit("profile5m", "mm");
                socket.emit("isp5m", "mm");
                socket.emit("device5m", "mm");
                socket.emit("info5m", "mm");
            } else if ($(this).val() == 3) {
                socket.emit("messageHH", "HH");
                socket.emit("productHH", "HH");
                socket.emit("profileHH", "HH");
                socket.emit("ispHH", "HH");
                socket.emit("deviceHH", "HH");
                socket.emit("infoHH", "HH");
            } else if ($(this).val() == 4) {
                socket.emit("messagedd", "dd");
                socket.emit("productdd", "dd");
                socket.emit("profiledd", "dd");
                socket.emit("ispdd", "dd");
                socket.emit("devicedd", "dd");
                socket.emit("infodd", "dd");
            } else if ($(this).val() == 5) {
                socket.emit("messageMM", "MM");
                socket.emit("productMM", "MM");
                socket.emit("profileMM", "MM");
                socket.emit("ispMM", "MM");
                socket.emit("deviceMM", "MM");
                socket.emit("infoMM", "MM");
            }


        });
    })

    function drawData(data, setContainer) {
        var dataX = []
        var dataSubY = []
        var keys = Object.keys(data);
        for (var i = keys.length - 1; i >= 0; i--) {
            var dateString = data[keys[i]].date_min
            var year = dateString.substring(0, 4);
            var month = dateString.substring(4, 6);
            var day = dateString.substring(6, 8);
            var hour = dateString.substring(8, 10);
            var minute = dateString.substring(10, 12);
            var date = new Date(year, month, day, hour, minute)
            date.setHours(date.getHours() + 7)
            dataX.push(date.getHours() + ":" + date.getMinutes())
            dataSubY.push(data[keys[i]].value);

        }
        var dataY = [{
            name: 'All',
            data: dataSubY
        }]

        $(setContainer).highcharts({

            title: {
                text: 'Monthly Average Session',
                x: -20 //center
            },
            subtitle: {
                text: 'Source: Nginx and Wowza Stream',
                x: -20
            },

            xAxis: {
                categories: dataX
            },
            yAxis: {
                title: {
                    text: 'Unique count of session'
                },
                plotLines: [{
                    value: 0,
                    width: 1,
                    color: '#808080'
                }]
            },
            tooltip: {
                valueSuffix: ' session'
            },
            legend: {
                layout: 'vertical',
                align: 'right',
                verticalAlign: 'middle',
                borderWidth: 0
            },
            series: dataY
        });
    }

    function drawDataArray(data, setContainer) {

        var keys = Object.keys(data)
        var array = data[keys[0]].value

        console.log(array)
        $(setContainer).highcharts({
            chart: {
                plotBackgroundColor: null,
                plotBorderWidth: null,
                plotShadow: false,
                type: 'pie'
            },
            title: {
                text: 'Product\'s HDViet'
            },
            tooltip: {
                pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b>'
            },
            plotOptions: {
                pie: {
                    allowPointSelect: true,
                    cursor: 'pointer',
                    dataLabels: {
                        enabled: true,
                        format: '<b>{point.name}</b>: {point.percentage:.1f} %',
                        style: {
                            color: (Highcharts.theme && Highcharts.theme.contrastTextColor) || 'black'
                        }
                    }
                }
            },
            series: [{
                name: "Brands",
                colorByPoint: true,
                data: array
            }]
        });
    }

    function socketData(paraChannel, setContainer) {

        socket.on(paraChannel, function (data) {

            console.log(data)
            drawData(data, setContainer)

        })

    }

    function socketDataArray(paraChannel, setContainer) {

        socket.on(paraChannel, function (data) {

            console.log(data)
            drawDataArray(data, setContainer)

        })

    }

    $(function () {

        socketData("sessions_time", '#containerSession')
        socketDataArray("product_time", '#containerProduct')
        socketDataArray("profile_time", '#containerProfile')
        socketDataArray("isp_time", '#containerISP')
        socketDataArray("device_time", '#containerDevice')
        socketDataArray("info_time", '#containerInfo')

    });

</script>


</body>
</html>